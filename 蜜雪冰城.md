![需求分析](./images/需求分析.png)

## 初始化项目

#### 创建项目

1. 使用测试号登录选用 TypeScript + Sass 版本的模板，进入项目

2. 先创建底部导航部分

*app.json*

```js
   {
     "pages": [
       "pages/index/index",
       "pages/menu/index",
       "pages/order/index",
       "pages/me/index"
     ],
     "window": {
       "backgroundTextStyle": "light",
       "navigationBarBackgroundColor": "#fff",
       "navigationBarTitleText": "Weixin",
       "navigationBarTextStyle": "black"
     },
     "tabBar": {
       "list": [
         {
           "pagePath": "pages/index/index",
           "text": "首页"
         },
         {
           "pagePath": "pages/menu/index",
           "text": "点餐"
         },
         {
           "pagePath": "pages/order/index",
           "text": "订单"
         },
         {
           "pagePath": "pages/me/index",
           "text": "我的"
         }
       ]
     },
     "style": "v2",
     "sitemapLocation": "sitemap.json"
   }
```

#### 首页轮播图和轮播图页面的跳转

1. project.config.json 中的 TypeScript 删除和 app.js 中的语法错误删除

```js
// project.config.json

"setting": {
    "useCompilerPlugins": [
      // "typescript",
      "sass"
    ],
        
// app.js 
App<IAppOption>({   -->   APP({})
```

2. pages/index/index.json

```js
{
  "navigationStyle": "custom"
} 
// 取消头部导航栏部分，这样就可以撑满整个屏幕
```

3.  pages/index/index.wxml

```html
   <view class="page">
    <view class="swiper-container">
     <swiper>
      <!-- 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 mode="aspectFill" 防止图片变形-->
       <swiper-item wx:for="{{ swiperList }}" wx:key="index">
         <image mode="aspectFill" src="{{ item.imageUrl }}"></image>
       </swiper-item>
     </swiper>
     <view class="dots">
     <!-- 如果 current == index  会有一个 active 属性-->
         
     <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
     </view>
    </view>
</view>
```

4. pages/index/index.scss

```js
.swiper-container{
  width: 100vw;
  height: 630rpx;
  swiper{
    height: 100%;
    image{
      width: 100%;
      height: 100%;
    }
  }
}
```

## 开始项目

#### 实现轮播图页面按钮样式切换

5. pages/index/index.wxml

```html
<view class="page">
 <view class="swiper-container">
 <!--3. 我们怎么知道图片切换去切换小圆圈的状态呢，这里有个bindchange事件 -->
  <swiper bindchange="onSwiperChange">
   <!--1. 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 -->
    <swiper-item wx:for="{{ swiperList }}" wx:key="index">
      <image mode="aspectFill" src="{{ item.imageUrl }}"></image>
    </swiper-item>
  </swiper>
  <view class="dots">
  <!--2. 如果 current == index  会有一个 active 属性-->
  <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
  </view>
 </view>
</view>
```

6. pages/index/index.scss

```scss
.swiper-container{
  width: 100vw;
  height: 630rpx;
  position: relative;
  swiper{
    height: 100%;
    image{
      width: 100%;
      height: 100%;
      // 下面有一点的弧度
      border-bottom-left-radius: 20rpx;
      border-bottom-right-radius: 20rpx;
    }
  }
  // 固定的区域，轮播图里面的切换图片的小标识
  .dots{
    position: absolute;
    left: 50rpx;
    bottom: 50rpx;
    // 这样的话下面的 dot 小圆圈就可以按照flex进行排布
    display: inline-flex;
    .dot{
      width: 8rpx;
      height: 8rpx;
      background-color: #fff;
      opacity: .5;
      // 因为上面是正方块，所以这里应该是半径 4rpx 的圆
      border-radius: 4rpx;
      // 每个小圆的间隔是 4rpx
      margin-left: 4rpx;
      // 1s 过渡
      transition: all 1s;
      &.active {
        // 如果是被选中状态的话，那么这里就会从圆变成一个条状的切换样式
        width: 29rpx;
        opacity: 1;
      }
    }
  }
}
```

7. pages/index/index.js

```js
// pages/index/index.ts
Page({

  /**
   * 页面的初始数据
   */
  data: {
    swiperList:[
      {
        imageUrl:'../../assets/images/lb1.png',
        type:'url',
        target:"http://baidu.com"
      },
      {
        imageUrl:'../../assets/images/lb2.png',
        // 跳转到产品具体的详情页
        type:'product',
        target:"1"
      },
      {
        imageUrl:'../../assets/images/lb3.png',
        type:'url',
        target:"http://baidu.com"
      }
    ],
    current:0
  },
  // 当轮播图切换的时候，调用这个方法，给 current 重新赋值，改变切换按钮的样式
  onSwiperChange(e){
    // 可以先进行解构，将里面的 current 拿出来
    const { current } = e.detail
    this.setData({
      current
    })
  }
})
```

#### 使用云开发的方式存储数据

1. 云开发-内容管理-访问地址-创建新项目蜜雪冰城-内容模型-新建模型

   ```js
   // 1.内容类型 图片
   1. 展示名称：轮播图
   2. 数据库字段名：imgUri
   3. 资源链接格式：HTTPS
   4. 是否必须：开启
   // 2.内容类型 枚举
   1. 展示名称：跳转类型
   2. 数据库字段名：type
   3. 资源链接格式：url
   4. 枚举元素类型：字符串
   5. 枚举元素：
     5.1 网址 url
     5.2 产品 product
   6. 是否必须：开启
   // 3. 内容类型 单行字符串
   1. 展示名称：目标
   2. 数据库字段名：target
   3. 是否必须：开启
   ```

2. 内容集合-轮播图-新建

   ```js
   1. 传入图片 
   跳转类型：网址 
   目标：https://baodu.com
   2. 传入图片 
   跳转类型：产品
   目标：123
   3. 传入图片
   跳转类型：产品
   目标：2
   ```

3. 获取云开发数据库中的数据

   api/swiper.js

   ```js
   // 这里是获取 swiper 的方式，简答的封装了一层API，获取数据可以通过这种方式获取
   // 但是这样定义之前需要先在 app.js 里面初始化
   import {db} from './cloud-init'
   const list = () => {
     return db.collection('mx_swiper').get();
   }
   
   export default {
     list
   }
   ```

   app.js

   ```js
   // app.ts
   App({
     globalData: {},
     onLaunch() {
       // 初始 cloud 功能，初始一下环境，才能调用方法 const db = wx.cloud.database() 去调用数据库
       wx.cloud.init();
   
       // 展示本地存储能力
       const logs = wx.getStorageSync('logs') || []
       logs.unshift(Date.now())
       wx.setStorageSync('logs', logs)
    
       // 登录
       wx.login({
         success: res => {
           console.log(res.code)
           // 发送 res.code 到后台换取 openId, sessionKey, unionId
         },
       })
     },
   })
   ```

   pages/index/index.js

   ```js
   import swiper from "../../api/swiper"
   
   // pages/index/index.ts
   Page({
     data: {
       // 创建一个空的数组元素   
       swiperList:[],
       current:0
     },
     // 当轮播图切换的时候，调用这个方法，给 current 重新赋值，改变切换按钮的样式
     onSwiperChange(e){
       // 可以先进行解构，将里面的 current 拿出来
       const { current } = e.detail
       this.setData({
         current
       })
     },
     /**
      * 生命周期函数--监听页面加载
      */
     onLoad() {
     // 在这里获取图片，我们通过在 api 里面封装了API，获取云开发中的数据
      swiper.list().then(res=>{
       // console.log(res);
        this.setData({
          swiperList:res.data
        })
      })
     }
   })
   ```

   pages/index/index.wxml

   ```html
   <view class="page">
   <!-- 如果 swiperList 里面没有数据不会渲染轮播图-->
    <view wx:if="{{swiperList.length}}" class="swiper-container">
    <!--3. 我们怎么知道图片切换去切换小圆圈的状态呢，这里有个bindchange事件 -->
     <swiper bindchange="onSwiperChange">
      <!--1. 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 -->
       <swiper-item wx:for="{{ swiperList }}" wx:key="index">
         <image mode="aspectFill" src="{{ item.imgUri }}"></image>
       </swiper-item>
     </swiper>
     <view class="dots">
     <!--2. 如果 current == index  会有一个 active 属性-->
     <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
     </view>
    </view>
   </view>
   ```

#### 实现轮播图的跳转功能

1. pages/index/index.wxml

   ```html
   <view class="page">
    <view wx:if="{{swiperList.length}}" class="swiper-container">
     <swiper bindchange="onSwiperChange">
       <swiper-item wx:for="{{ swiperList }}" wx:key="index">
        <!--绑定一个点击事件，并且把数据item传入，因为后续要对item里面的数据类型进行判断是如何进行跳转的-->   
         <image bindtap="onSwiperTab" data-item="{{item}}" mode="aspectFill" src="{{ item.imgUri }}"></image>
       </swiper-item>
     </swiper>
     <view class="dots">
     <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
     </view>
    </view>
   </view>
   ```

2. pages/index/index.js

   ```js
   import swiper from "../../api/swiper"
   
   // pages/index/index.ts
   Page({
     data: {
       swiperList:[],
       current:0
     },
     //1. 当轮播图切换的时候，调用这个方法，给 current 重新赋值，改变切换按钮的样式
     onSwiperChange(e){
       // 可以先进行解构，将里面的 current 拿出来
       const { current } = e.detail
       this.setData({
         current
       })
     },
       
     // 轮播图的跳转效果，这里首先对其进行判断
     // 2. 当手指点图片的时候跳转页面
     onSwiperTab(e){
       // 获取传过来的数据，item
       const {item} = e.currentTarget.dataset
       // console.log(item);
       // 如果里面类型是type，说明是跳转的url，走第一个选项，如果不是走第二个
       item.type === 'url' ? wx.navigateTo({
         url: `/pages/web-view/index?url=${item.target}`,
       }) : wx.navigateTo({
         url: `/pages/product/detail?id=${item.target}`,
       })
     },
   
     onLoad() {
     // 在这里获取图片，我们通过在 api 里面封装了API，获取云开发中的数据
      swiper.list().then(res=>{
       // console.log(res);
        this.setData({
          swiperList:res.data
        })
      })
     }
   })
   ```

3. 创建两张页面 app.json

   ```js
   {
     "pages": [
       "pages/index/index",
       "pages/menu/index",
       "pages/order/index",
       "pages/me/index",
         
       // 创建出来两个需要跳转的页面
       "pages/web-view/index",
       "pages/product/detail"
     ],
     "window": {
       "backgroundTextStyle": "light",
       "navigationBarBackgroundColor": "#fff",
       "navigationBarTitleText": "Weixin",
       "navigationBarTextStyle": "black"
     },
     "tabBar": {
       "list": [
         {
           "pagePath": "pages/index/index",
           "text": "首页"
         },
         {
           "pagePath": "pages/menu/index",
           "text": "点餐"
         },
         {
           "pagePath": "pages/order/index",
           "text": "订单"
         },
         {
           "pagePath": "pages/me/index",
           "text": "我的"
         }
       ]
     },
     "style": "v2",
     "sitemapLocation": "sitemap.json"
   }
   ```

4. 获取需要跳转到的 url      pages/web-view/index.js

   ```js
    // pages/web-view/index.js
    Page({
      data: {
        url:null
      },

      onLoad(options) {
        // console.log(options.url); // 这里地址就过来了,地址赋值给上面data里面的url
        this.setData({
          url:options.url
        })
      }
    })
   ```

5. 设置跳转到的页面里面   pages/web-view/index.wxml

   ```js
	<view wx:if="{{url}}" src="{{url}}"></view>
   ```

#### Tabbar & 首页会员卡片

```js
1. 会员
   - 积分
	 - 我的积分
   - 会员成长值(分数)
2. 定位点餐
3. 今天喝什么
   - 公众号文章跳转
4. 优惠券
5. 积分商城(雪王魔法阵)
```

1. 底部 Tabbar

```js
{
  "pages": [
    "pages/index/index",
    "pages/menu/index",
    "pages/order/index",
    "pages/me/index",
    "pages/web-view/index",
    "pages/product/detail"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "Weixin",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#797979",
    "selectedColor": "#E60012",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "./assets/images/home.png",
        "selectedIconPath": "./assets/images/home-selected.png"
      },
      {
        "pagePath": "pages/menu/index",
        "text": "点餐",
        "iconPath": "./assets/images/menu.png",
        "selectedIconPath": "./assets/images/menu-selected.png"
      },
      {
        "pagePath": "pages/order/index",
        "text": "订单",
        "iconPath": "./assets/images/order.png",
        "selectedIconPath": "./assets/images/order-selected.png"
      },
      {
        "pagePath": "pages/me/index",
        "text": "我的",
        "iconPath": "./assets/images/me.png",
        "selectedIconPath": "./assets/images/me-selected.png"
      }
    ]
  },
  "style": "v2",
  "sitemapLocation": "sitemap.json"
}
```

2. app.scss

```scss
/**app.wxss**/
.page {
  background-color: #fefefe;
  display: flex;
  flex-direction: column;
  align-items: center;
} 
```

##### 会员卡片

1. pages/index/index.wxml

```html
<view class="page">
<!-- 1. 轮播图-->
 <view wx:if="{{swiperList.length}}" class="swiper-container">
 <!--3. 我们怎么知道图片切换去切换小圆圈的状态呢，这里有个bindchange事件 -->
  <swiper bindchange="onSwiperChange" autoplay="true" interval="3000" duration="1000" circular="true">
   <!--1. 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 -->
    <swiper-item wx:for="{{ swiperList }}" wx:key="index">
      <image bindtap="onSwiperTab" data-item="{{item}}" mode="aspectFill" src="{{ item.imgUri }}"></image>
    </swiper-item>
  </swiper>
  <view class="dots">
  <!--2. 如果 current == index  会有一个 active 属性-->
  <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
  </view>
 </view>
    
 <!--2. 会员/积分区域 -->
 <view class="member-area">
 <!-- 左侧会员区域 -->
 <view class="vip-box">
 <image src="../../assets/images/vip-pic.png"></image>
 <view class="meta">
 <view class="title">微雪花会员</view>
  <!-- 拆分组件部分 -->
 <progress-bar value="{{ 33 }}" width="320rpx"/>
 <view class="tips">再升1级可享【升级礼包】等6项权益</view>
 </view>

 <!-- 右侧积分区域 -->
 <view class="coin-box">
 <image src="../../assets/images/coin.png"></image>
 <view class="currency">51</view>
 </view>
 </view> 
 </view>
</view>
```

2. pages/index/index.json

```js
{
  "navigationStyle": "custom",
  "usingComponents": {
     // 引入组件
    "progress-bar":"../../components/progress-bar/index"
  }
} 
```

3. 创建组件经验条部分  components/progress-bar/index.wxml

```html
<!-- 经验条组件类型1
<view class="track" style="{{!trackColor ? 'background-color:' + trackColor + ';' : ''}} {{ width ? 'width:' + width + ';' : ''}}">
  <view class="bar" style="{{ value > 0 ? 'width:' + value + '%;' : ''}} {{!color|| 'background-color:' + color + ';'}}">
  </view>
</view> -->

<!-- 经验条组件类型二 -->
<!-- 如果正常情况下，这里判断就很麻烦，所以这里指定了两个属性，在js文件中，设置具体内容 -->
<view class="track" style="{{ trackStyle }}">
  <view class="bar" style="{{ barStyle }}">
  </view>
</view>
```

4. components/progress-bar/index.json

```js
{
  "component": true,
  "navigationStyle": "custom",
  "usingComponents": {
  }
}
```

5. components/progress-bar/index.js

```js
// components/progress-bar/index.js
Component({
  properties: {
    // 接收参数 color 是条的颜色
    color:{
      type:String,
      value:''
    },
    // trackColor 是背景的颜色
    trackColor:{
      type:String,
      value:''
    },
    // value就是一个值，这里一般都是百分比
    value:{
      type:Number,
      value:0
    },
    // 如果不加width，那么是占满整个区域，如果指定了width那么就可以限制区域
    width:{
      type:String,
      value:''
    }
  },
  data: {
  trackStyle:'',
  barStyle:'',
  },
lifetimes:{
  attached(){
    // 两个style的产出，这里是 组件被放在页面的时候 就去执行函数
    this.buildTrackStyle();
    this.buildBarStyle();
  }
},

  methods: {
    // buildTrackStyle对轨道进行计算，就是背景
    buildTrackStyle(){
      // 定义初始值，如果下面两个条件都没达到，那么就给值里面塞进去一个空的 trackStyle
      let trackStyle = '';
      // 判断width是否存在，如果存在加入 width 属性
      // 语法糖：如果前面是真的，就是传入了 width 那么就不会执行后面的部分，如果前面是false，才会执行后面的代码

      // if(this.properties.width){
      //   trackStyle += `width:${this.properties.width
      // } 
      // 与下面类似
      !this.properties.width || (trackStyle += `width:${this.properties.width};`)

      !this.properties.trackStyle || (trackStyle += `background-color:${this.properties.trackStyle};`)
      this.setData({
        trackStyle
      })
    },
    buildBarStyle(){
        // 定义初始值
        let barStyle = '';
        // 判断width是否存在，如果存在加入 width 属性，这里不是随便加的，如果是在0~100之间才加入进去，否则就不加入，并且后面是个数字，所以要加入%
        (this.properties.value <= 0 && this.properties.value >100) || (barStyle += `width:${this.properties.value}%;`)

        !this.properties.color || (barStyle += `background-color:${this.properties.color};`)
        this.setData({
          barStyle
        })
    }
  }
})
```

6. components/progress-bar/index.scss

```js
/* components/progress-bar/index.wxss */
.track{
  // 进度条部分
  background-color: #ebebeb;
  height: 6rpx;
  width: 100%;
  border-radius: 3rpx;
  // 进度条里面是竖装的，这里需要超出隐藏掉
  overflow: hidden;
}
.bar{
  background-color: #E60012;
  height: 100%;
  width: 0;
}
```

7. pages/index/index.scss

```scss
.swiper-container{
  width: 100vw;
  height: 630rpx;
  position: relative;
  swiper{
    height: 100%;
    image{
      width: 100%;
      height: 100%;
      // 下面有一点的弧度
      border-bottom-left-radius: 20rpx;
      border-bottom-right-radius: 20rpx;
    }
  }
  // 固定的区域，轮播图里面的切换图片的小标识
  .dots{
    position: absolute;
    left: 50rpx;
    bottom: 58rpx;
    // 这样的话下面的 dot 小圆圈就可以按照flex进行排布
    display: inline-flex;
    .dot{
      width: 8rpx;
      height: 8rpx;
      background-color: #fff;
      opacity: .5;
      // 因为上面是正方块，所以这里应该是半径 4rpx 的圆
      border-radius: 4rpx;
      // 每个小圆的间隔是 4rpx
      margin-left: 4rpx;
      // 1s 过渡
      transition: all 1s;
      &.active {
        // 如果是被选中状态的话，那么这里就会从圆变成一个条状的切换样式
        width: 29rpx;
        opacity: 1;
      }
    }
  }
}
.member-area{
  margin-top: -40rpx;
  z-index: 2;
  overflow: hidden;
  width: 688rpx;
  height: 174rpx;
  border-radius: 16rpx;
  background-color: #fefefe;
  // 给盒子一个阴影
  box-shadow: 0px 0px 8px rgba(0,0,0,0.2);
  display: flex;
  // 将盒子里面元素在同一行排布
  flex-direction: row;
  // 排布在盒子的两端
  justify-content: space-between;
  // 使图标显示在中间位置
  padding: 30rpx;
  // 这样防止盒子因为 padding 变大
  box-sizing: border-box;
  .vip-box{
    display: flex;
    image{
      width: 100rpx;
      height: 100rpx;
      border-radius: 50rpx;
      overflow: hidden;
      margin-right: 26rpx;
      // 这样不会在空间不够的情况下使图片变形，默认情况下是1，空间不够自动缩小
      flex-shrink: 0;
    }
    .meta{
      .title{
        font-size: 32rpx;
        font-weight: bold;
        margin-bottom: 18rpx;
      }
      .tips{
        margin-top: 14rpx;
        color: #777777;
        font-size: 24rpx;
      }
    }
  }
  .coin-box{
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-right: -45rpx;
    image{
      width: 130rpx;
      height: 70rpx;
    }
    .currency{
      color: #d32d25;
      margin-left: 26rpx;
      font-weight: bold;
    }
  }
}
```

#### 手机号码快捷登录

```js
思路：
云调用的方式，云开发会给我们提供一个云调用的机制，我们可以载运函数里面直接拿到加密的data传到云函数，云函数就可以拿到手机号，拿到手机号以后，我们就只要把手机号码存储到我们的后台用户列表里面，用户列表就会根据这边的数据，这个用户列表也只是手机号码，不会拿到其他的东西，比较简化一点，这个手机号码拿到以后，我们就可以在数据库的权限里面只能看到自己的手机号码的权限，这样就可以绑定这个手机号码，可以知道某一个手机号码是不是属于他的，再根据这个对数据进行筛选。我们对数据筛选我们可以用ID，我们在数据库写的时候，有些数据只是他自己能看到的，我们就用数据权限的方式去分割，不需要有太多的对用户的关联操作。
登录比较简单一点就是：暂时这里不需要gwt，给一个token这样非常复杂的登录体系
只需要保持当前的session，我们可以在data里面存储一个手机号码，如果没有登录，我们还不知道他是谁，这里必须要授权登录，然后去数据库里面查找，再提供区分的服务，简单的鉴权，以手机号码为主，当前如果localStorage里面存储了手机号码，我们只需要对这个手机号码提供服务就可以了，如果当前不是这个手机号码，我们就可以让选择手机号码登录，再对手机号码进行存储
```

1. app.json 创建一个登录页面

```js
{
  "pages": [
    "pages/index/index",
    "pages/menu/index",
    "pages/order/index",
    "pages/me/index",
    "pages/web-view/index",
    "pages/product/detail",
    "pages/login/index"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "蜜雪冰城",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#797979",
    "selectedColor": "#E60012",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "./assets/images/home.png",
        "selectedIconPath": "./assets/images/home-selected.png"
      },
      {
        "pagePath": "pages/menu/index",
        "text": "点餐",
        "iconPath": "./assets/images/menu.png",
        "selectedIconPath": "./assets/images/menu-selected.png"
      },
      {
        "pagePath": "pages/order/index",
        "text": "订单",
        "iconPath": "./assets/images/order.png",
        "selectedIconPath": "./assets/images/order-selected.png"
      },
      {
        "pagePath": "pages/me/index",
        "text": "我的",
        "iconPath": "./assets/images/me.png",
        "selectedIconPath": "./assets/images/me-selected.png"
      }
    ]
  },
  "style": "v2",
  "sitemapLocation": "sitemap.json"
}
```

2. pages/index/index.wxml

```html
<view class="page">
  <image class="logo" src="../../assets/images/me-avatar.png"></image>
  <view class="logo-title">蜜雪冰城</view>
  <view class="intro">成为会员，立享更多优惠福利</view>
  <view class="login-tip">授权绑定手机号 为您提供更好的服务</view>
  <button open-type="getPhoneNumber" class="login-btn"  bindgetphonenumber="login">一键登录</button>
  <view class="cancel" bindtap="">取消</view>
</view>
```

3. pages/index.index.scss

```scss
@import '../../style/theme.scss';
.page{
  padding-top: 176rpx;
  .logo{
    width: 150rpx;
    height: 150rpx;
    border-radius: 75rpx;
    overflow: hidden;
    margin-bottom: 22rpx;
  }
  .logo-title{
    margin-bottom: 160rpx;
  }
  .intro{
    font-size: 37rpx;
    font-weight: bold;
    margin-bottom: 84rpx;
  }
  .login-tip{
    font-size: 20rpx;
    color: $gray-text-color;
  }
  .login-btn{
    width: 368rpx;
    height: 85rpx;
    background-color:$primary-color;
    color: white;
    border-radius: 10rpx;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 42rpx;
    &.button-hover{
      opacity: 0.6;
    }
  }
  .cancel{
    color: #aaaaaa;
  }
}
```

4. style/theme.scss

```js
// 配置两个通用的颜色，需要的地方直接引入
$primary-color:#E60012;
$gray-text-color:#777777
```

5. 获取手机号暂时先不做，由于个人认证的用户无法获取手机号权限

```js
1. 先去创建 cloud-functions 文件夹
2. 然后去 project.config.json 中添加配置 "cloudfunctionRoot": "cloud-functions/",
    {
  "description": "项目配置文件",
  "packOptions": {
    "ignore": [],
    "include": []
  },
  "cloudfunctionRoot": "cloud-functions/",
  "miniprogramRoot": "miniprogram/",
  "compileType": "miniprogram",
  "projectname": "ts-sass-demo",
   "setting": {
       ...
   }
}
```

6. pages/login/index.js

```js
// pages/login/index.js
Page({

  /**
   * 页面的初始数据
   */
  data: {

  },
  login(e){
    // 注意这里如果是个人认证是没有办法拿到手机号的
    // console.log(e);
    const cloudId = e.detail.CloudID
    wx.cloud.callFunction({
      name:'get-phone-number',
      data:{
        weRunData: wx.clouod.CloudID(cloudId), // 这个 CloudID 值到云函数端会被替换
      }
    }).then(res=>{
      console.log(res);
    })
  },
  onLoad(options) {

  },
})
```

7. 选择做 如果想要看一下获取的都是那些信息，我们需要对云函数进行修改 

cloud-functions/get-phone-number/index.js

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
   // return event.weRunData.data.phoneNumber
   // 改为
   return event.weRunData.data
}
// 然后这时候需要右键 cloud-functions/get-phone-number 文件夹-选择上传并部署所有文件
```

8. pages/index/index.js

```js
// pages/login/index.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    // 初始化登录成功后的跳转
    goto:''
  },
  login(e){
    // // 注意这里如果是个人认证是没有办法拿到手机号的
    // // console.log(e);
    // const cloudId = e.detail.CloudID
    // wx.cloud.callFunction({
    //   name:'get-phone-number',
    //   data:{
    //     weRunData: wx.clouod.CloudID(cloudId), // 这个 CloudID 值到云函数端会被替换
    //   }
    // }).then(res=>{
    //   // console.log(res);
    //   // 根据手机号码判断是否登录
    //   wx.setStorage("phoneNumber",res.result)
    //   // 跳转回来
    //   wx.switchTab({
    //     url: this.data.goto,
    //   })
    // })


    // 由于上面是个人用户，无法获取手机号，所以这里选择不去获取手机号，直接跳转页面
    wx.switchTab({
      url: this.data.goto,
    })
    wx.showToast({
      title: '登录成功',
      icon:"success",
      mask:true
    })
    wx.setStorageSync('phoneNumber', 132981691233)
  },
  onLoad(options) {
    const goto = '/pages/index/index'
    this.setData({
      goto
    })
  },

})
```

9. 然后对首页的登录状态进行修改 pages/index/index.js

```js
import swiper from "../../api/swiper"

// pages/index/index.ts
Page({

  /**
   * 页面的初始数据
   */
  data: {
    swiperList:[
      // {
      //   imageUri:'../../assets/images/lb1.png',
      //   type:'url',
      //   target:"http://baidu.com"
      // },
      // {
      //   imageUri:'../../assets/images/lb2.png',
      //   // 跳转到产品具体的详情页
      //   type:'product',
      //   target:"1"
      // },
      // {
      //   imageUri:'../../assets/images/lb3.png',
      //   type:'url',
      //   target:"http://baidu.com"
      // }
    ],
    current:0,    // 轮播图小图标切换
    memberInfo:null
  },

  //1. 当轮播图切换的时候，调用这个方法，给 current 重新赋值，改变切换按钮的样式
  onSwiperChange(e){
    // 可以先进行解构，将里面的 current 拿出来
    const { current } = e.detail
    this.setData({
      current
    })
  },
  // 2. 当手指点图片的时候跳转页面
  onSwiperTab(e){
    // 获取传过来的数据，item
    const {item} = e.currentTarget.dataset
    // console.log(item);
    // 如果里面类型是type，说明是跳转的url，走第一个选项，如果不是走第二个
    item.type === 'url' ? wx.navigateTo({
      url: `/pages/web-view/index?url=${item.target}`,
    }) : wx.navigateTo({
      url: `/pages/product/detail?id=${item.target}`,
    })
  },
  // 登录按钮操作
  gotoLogin(){
    wx.navigateTo({
      url: '/pages/login/index',
    })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad() {
  // 在这里获取图片，我们通过在 api 里面封装了API，获取云开发中的数据
   swiper.list().then(res=>{
    // console.log(res);
     this.setData({
       swiperList:res.data
     })
   })
  },
  onShow(){
    // 去拿手机号数据，如果有数据，那么就说明登录过了
    this.loadNumberInfo()
  },
  loadNumberInfo(){
   if(wx.getStorageSync('phoneNumber')){
    this.setData({
      memberInfo:wx.getStorageSync('phoneNumber')
    })
   }
  }
})
```

10. pages/login/index.wxml

```html
<view class="page">
<!-- 1. 轮播图-->
 <view wx:if="{{swiperList.length}}" class="swiper-container">
 <!--3. 我们怎么知道图片切换去切换小圆圈的状态呢，这里有个bindchange事件 -->
  <swiper bindchange="onSwiperChange" autoplay="true" interval="3000" duration="1000" circular="true">
   <!--1. 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 -->
    <swiper-item wx:for="{{ swiperList }}" wx:key="index">
      <image bindtap="onSwiperTab" data-item="{{item}}" mode="aspectFill" src="{{ item.imgUri }}"></image>
    </swiper-item>
  </swiper>
  <view class="dots">
  <!--2. 如果 current == index  会有一个 active 属性-->
  <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
  </view>
 </view>
 <!--2. 会员/积分区域 -->
 <view class="member-area">
 <!-- 左侧会员区域 -->
 <view class="vip-box">
 <image src="../../assets/images/vip-pic.png"></image>
 <view class="meta">
 <view class="title">{{memberInfo ? '微雪花会员' : '尊敬的用户'}}</view>
 <progress-bar value="{{ 33 }}" width="320rpx"/>
 <view class="tips">{{memberInfo ? '再升1级可享【升级礼包】等6项权益' :'会员可享【闲时优惠】等多项权益'}}</view>
 </view>
</view> 

 <!-- 右侧积分区域 -->
 <!-- 登录状态 -->
 <view wx:if="{{ memberInfo }}"  class="coin-box">
 <image src="../../assets/images/coin.png"></image>
 <view class="currency">51</view>
 </view>
<!-- 非登录状态，显示按钮 -->
<view wx:if="{{ !memberInfo }}" class="login-btn" bindtap="gotoLogin">授权登录</view>
 </view>
</view>
```

#### 首页&我的页面

1. pages/index/index.wxml

```html
<view class="page">
  <!-- 1. 轮播图-->
  <view wx:if="{{swiperList.length}}" class="swiper-container">
    <!--3. 我们怎么知道图片切换去切换小圆圈的状态呢，这里有个bindchange事件 -->
    <swiper bindchange="onSwiperChange" autoplay="true" interval="3000" duration="1000" circular="true">
      <!--1. 轮播里面包括图片，里面一个是轮播一个是轮播标识，里面一个是图片一个是跳转链接 -->
      <swiper-item wx:for="{{ swiperList }}" wx:key="index">
        <image bindtap="onSwiperTab" data-item="{{item}}" src="{{ item.imgUri }}"></image>
      </swiper-item>
    </swiper>
    <view class="dots">
      <!--2. 如果 current == index  会有一个 active 属性-->
      <view class="dot {{current !== index || 'active'}}" wx:for="{{ swiperList }}" wx:key="index"></view>
    </view>
  </view>
  <!--2. 会员/积分区域 -->
  <view class="member-area">
    <!-- 左侧会员区域 -->
    <view class="vip-box">
      <image src="../../assets/images/vip-pic.png"></image>
      <view class="meta">
        <view class="title">{{memberInfo ? '微雪花会员' : '尊敬的用户'}}</view>
        <progress-bar value="{{ 33 }}" width="320rpx" />
        <view class="tips">{{memberInfo ? '再升1级可享【升级礼包】等6项权益' :'会员可享【闲时优惠】等多项权益'}}</view>
      </view>
    </view>

    <!-- 右侧积分区域 -->
    <!-- 登录状态 -->
    <view wx:if="{{ memberInfo }}" class="coin-box">
      <image src="../../assets/images/coin.png"></image>
      <view class="currency">51</view>
    </view>
    <!-- 非登录状态，显示按钮 -->
    <view wx:if="{{ !memberInfo }}" class="login-btn" bindtap="gotoLogin">授权登录</view>
  </view>

  <!-- 点餐banner star-->
  <view class="menu-banner">
    <view class="location">
      <image src="../../assets/images/address.png"></image>
      <view class="name">万达店</view>
    </view>
    <image class="menu-card" src="../../assets/images/menu-banner.jpg" bindtap="onMenuCardClick"></image>
  </view>
  <!-- 点餐banner end -->
</view>

<view class="banner-list">
  <image class="banner" src="../../assets/images/banner-1.jpg" bindtap="onArticleClick"></image>
  <image class="banner" src="../../assets/images/banner-2.jpg"></image>
  <image class="banner" src="../../assets/images/banner-3.jpg"></image>
</view>
```

2. pages/index/index.scss

```js
// 这里引入通用的颜色
@import '../../style/theme.scss';
.swiper-container{
  width: 100vw;
  height: 630rpx;
  position: relative;
  swiper{
    height: 100%;
    image{
      width: 100%;
      height: 100%;
      // 下面有一点的弧度
      border-bottom-left-radius: 20rpx;
      border-bottom-right-radius: 20rpx;
    }
  }
  // 固定的区域，轮播图里面的切换图片的小标识
  .dots{
    position: absolute;
    left: 50rpx;
    bottom: 58rpx;
    // 这样的话下面的 dot 小圆圈就可以按照flex进行排布
    display: inline-flex;
    .dot{
      width: 8rpx;
      height: 8rpx;
      background-color: #fff;
      opacity: .5;
      // 因为上面是正方块，所以这里应该是半径 4rpx 的圆
      border-radius: 4rpx;
      // 每个小圆的间隔是 4rpx
      margin-left: 4rpx;
      // 1s 过渡
      transition: all 1s;
      &.active {
        // 如果是被选中状态的话，那么这里就会从圆变成一个条状的切换样式
        width: 29rpx;
        opacity: 1;
      }
    }
  }
}
.member-area{
  margin-top: -40rpx;
  z-index: 2;
  overflow: hidden;
  width: 688rpx;
  height: 174rpx;
  border-radius: 16rpx;
  background-color: #fefefe;
  // 给盒子一个阴影
  box-shadow: 0px 0px 8px rgba(0,0,0,0.2);
  display: flex;
  // 将盒子里面元素在同一行排布
  flex-direction: row;
  // 排布在盒子的两端
  justify-content: space-between;
  align-items: center;
  // 使图标显示在中间位置
  padding: 0 20rpx;
  // 这样防止盒子因为 padding 变大
  box-sizing: border-box;
  margin-bottom: 44rpx;
  .vip-box{
    display: flex;
    image{
      width: 100rpx;
      height: 100rpx;
      border-radius: 50rpx;
      overflow: hidden;
      margin-right: 26rpx;
      // 这样不会在空间不够的情况下使图片变形，默认情况下是1，空间不够自动缩小
      flex-shrink: 0;
    }
    .meta{
      .title{
        font-size: 32rpx;
        font-weight: bold;
        margin-bottom: 18rpx;
      }
      .tips{
        margin-top: 14rpx;
        // 这里修改一下颜色的值
        // color:#777777
        color: $gray-text-color;
        font-size: 24rpx;
      }
    }
  }
  .coin-box{
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-right: -23rpx;
    image{
      width: 130rpx;
      height: 70rpx;
    }
    .currency{
      color: #d32d25;
      margin-left: 26rpx;
      font-weight: bold;
    }
  }
  //登录按钮样式
  .login-btn{
    width: 150rpx;
    height: 65rpx;
    border-radius: 10rpx;
    background-color: $primary-color;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 25rpx;
    &active{
      opacity: 0.6;
    }
  }
}

// 点餐区域
.menu-banner{
  width: 100%;
  padding: 0 28rpx;
  box-sizing: border-box;
  .location{
  display: flex;
  align-items: center;
  margin-bottom: 15rpx;
    image{
      margin-left: 10rpx;
      width: 24rpx;
      height: 24rpx;
    }
    .name{
      font-size: 22rpx;
      color: black;
      margin-left: 14rpx;
    }
  }
  .menu-card{
    width: 688rpx;
    height: 340rpx;
    box-shadow: 0px 0px 8px rgba(0,0,0,0.1);
    border-radius: 16rpx;
  }
}
.banner-list{
  display: flex;
  width: 100%;
  box-sizing: border-box;
  padding: 0 30rpx;
  justify-content: space-between;
  margin-bottom: 36rpx;
  .banner{
    width: 216rpx;
    height: 160rpx;
    box-shadow: 0px 0px 8px rgba(0,0,0,0.1);
    border-radius: 16rpx;
  }
}
```

3. pages/index/index.js

```js
import swiper from "../../api/swiper"

// pages/index/index.ts
Page({

  /**
   * 页面的初始数据
   */
  data: {
    swiperList:[
      // {
      //   imageUri:'../../assets/images/lb1.png',
      //   type:'url',
      //   target:"http://baidu.com"
      // },
      // {
      //   imageUri:'../../assets/images/lb2.png',
      //   // 跳转到产品具体的详情页
      //   type:'product',
      //   target:"1"
      // },
      // {
      //   imageUri:'../../assets/images/lb3.png',
      //   type:'url',
      //   target:"http://baidu.com"
      // }
    ],
    current:0,    // 轮播图小图标切换
    memberInfo:null
  },

  //1. 当轮播图切换的时候，调用这个方法，给 current 重新赋值，改变切换按钮的样式
  onSwiperChange(e){
    // 可以先进行解构，将里面的 current 拿出来
    const { current } = e.detail
    // console.log(current);
    this.setData({
      current
    })
  },
  // 2. 当手指点图片的时候跳转页面
  onSwiperTab(e){
    // 获取传过来的数据，item
    const {item} = e.currentTarget.dataset
    // console.log(item);
    // 如果里面类型是type，说明是跳转的url，走第一个选项，如果不是走第二个
    item.type === 'url' ? wx.navigateTo({
      url: `/pages/web-view/index?url=${item.target}`,
    }) : wx.navigateTo({
      url: `/pages/product/detail?id=${item.target}`,
    })
  },
  // 登录按钮操作
  gotoLogin(){
    wx.navigateTo({
      url: '/pages/login/index',
    })
  },

  // 点击点餐卡片跳转至菜单页
  onMenuCardClick(){
   if(wx.getStorageSync('phoneNumber')){
    wx.switchTab({
      url: '/pages/menu/index',
    })
   }else{
    wx.showToast({
      title: '请先登录',
      image:'../../assets/images/home-selected.png',
      mask:true,   //是否显示透明蒙层，防止触摸穿透，默认：false
    })
   }
  },
  // 点击最下面的去文章页面
  onArticleClick(){
    wx.navigateTo({
      url: '/pages/web-view/index?url=http://www.zhangqilong.cn',
    })
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad() {
  // 在这里获取图片，我们通过在 api 里面封装了API，获取云开发中的数据
   swiper.list().then(res=>{
    // console.log(res);
     this.setData({
       swiperList:res.data
     })
   })
  },
  onShow(){
    // 去拿手机号数据
    this.loadNumberInfo()
  },
  loadNumberInfo(){
   if(wx.getStorageSync('phoneNumber')){
    this.setData({
      memberInfo:wx.getStorageSync('phoneNumber')
    })
   }
  }
})
```

4. pages/index/index.json

```json
{
  "navigationStyle": "custom",
  "usingComponents": {
    "progress-bar":"../../components/progress-bar/index"
  }
} 
```

#### 我的页面

1. pages/me/index.wxml

```html
<!--pages/me/index.wxml-->
<view class="page">
  <!-- 用户区域 -->
  <view class="user-area">
    <view class="user-box">
      <image class="avatar" src="{{imgUri}}"></image>
      <view class="name">{{ phoneNumber || '登录获得更多会员权益' }}</view>
    </view>
    <view wx:if="{{ !phoneNumber }}" class="login-btn" bindtap="login">授权登录</view>
  </view>
  <!-- 卡片区域 -->
  <view  class="card-container">
    <!-- one -->
    <view class="card">
      <view class="meta">
        <view class="count">54</view>
        <view class="name">雪王币</view>
      </view>
      <image class="icon" src="../../assets/images/me-coin.png"></image>
    </view>
    <!-- second -->
    <view class="card">
      <view class="meta">
        <view class="count">54</view>
        <view class="name">优惠券</view>
      </view>
      <image class="icon" src="../../assets/images/me-coupon.png"></image>
    </view>
  </view>
  <!-- list区域 -->
  <view class="list-items">
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/qr-code.png"></image>
        <view class="label">兑换码</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- second -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/lock.png"></image>
        <view class="label">隐私政策</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- third -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/paper.png"></image>
        <view class="label">用户协议</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- forth -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/xuke.png"></image>
        <view class="label">经营信息公示</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
  </view>
  <!-- fifth -->
  <view class="list-items app-download">
      <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/app.png"></image>
        <view class="label">蜜雪冰城APP</view>
      </view>
      <view class="tips">下载APP体验更佳</view>
    </view>
    </view>
</view>
```

2. pages/me/index.scss

```scss
/* pages/me/index.wxss */
@import '../../style/theme.scss';
.page{
  // 渐变色，需要配合 height width 使用
  background: linear-gradient(to bottom,#fbe7e6,#f8f8f8);
  // view height 可视窗高度
  height: 100vh;
  width: 100%;
  box-sizing: border-box;
  padding: 0 30rpx;
  padding-top: 170rpx;
  .user-area{
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    .user-box{
      display: flex;
      align-items: center;
      .avatar {
        width: 120rpx;
        height: 120rpx;
      }
      .name{
        font-size: 28rpx;
        margin-left: 24rpx;
      }
    }
    .login-btn{
      width: 150rpx;
      height: 62rpx;
      background-color: $primary-color;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 25rpx;
      font-weight: bold;
      &.active{
        opacity: 0.6;
      }
    }
  }
  // 卡片区域
  .card-container{
    width: 100%;
    display: flex;
    justify-content: space-between;
    margin-bottom: 26rpx;
    .card{
      width: 330rpx;
      box-sizing: border-box;
      padding: 23rpx;
      border-radius: 15rpx;
      display: flex;
      margin-top: 20rpx;
      background-color: #fff;
      justify-content: space-between;
      align-items: center;
      .meta{
        .count{
          font-size: 24rpx;
          font-weight: bold;
        }
        .name{
          margin-top: 5rpx;
          font-size: 24rpx;
          color: $gray-text-color;
        }
      }
      .icon{
        width: 72rpx;
        height: 72rpx;
      }
    }
  }
  // list区域
  .list-items{
    display: flex;
    width: 100%;
    flex-direction: column;
    margin-bottom: 26rpx;
    .item{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 36rpx 30rpx;
      background-color: #fff;
      .content{
        display: flex;
        align-items: center;
        .icon{
          width: 40rpx;
          height: 40rpx;
          margin-right: 25rpx;
        }
        .label{
          font-size: 30rpx;
        }
      }
      .left-arrow{
        width: 30rpx;
        height: 30rpx;
      }
    }
    &.app-download{
    .tips{
      margin-right: 10rpx;
      font-size: 24rpx;
      color: $gray-text-color;
    } 
    }
  }
}
```

3. pages/me/index.js

```js
1. 在这里面，由于登录的操作是有两处，一个是在首页点餐的时候，我们需要登录。另外一个就是在我的页面的时候需要登录，但是由于我们之前设置的登录页面，登录之后返回的是首页。但是有个问题就是如果我们在我的页面的时候同样调用了login页面，那么我们在我的页面登录之后返回的也是首页，这样就非常的不合理，那么我是如何做的呢？，
2. 首先我在我的页面调用登录页的时候，我们可以传入一个参数 /pages/login/index?from=me
 login(){
    wx.navigateTo({
      url: '/pages/login/index?from=me',
    })
  },
3. 这样我们就可以在登录页的 onLoad(options)里面做一个判断，我们传入的参数是包括在onLoad(options)的options参数里面，这样我们就可以在没有手机号授权的情况下也可以进行判断是哪里来的，然后去精准控制要返回的页面

 onLoad(options) {
 // 从这个可以接收到调用login页面时候传入的参数，这样就可以精准控制要返回的页面，比如首页和我的页面都有登录操作，如果不能获取手机号的情况下，我们可以传入参数进行判断，是从哪里来的，比如这里就是传入了 from:me 进行得知
    console.log('login.js',options); 
       
    if(options.from == 'me'){
    // 如果是从我的页面来的
      const goto = '/pages/me/index'
      this.setData({
        goto
      })
    }else{
      // 如果是从首页登录来的
      const goto = '/pages/index/index'
      this.setData({
        goto
      })
    }
  },
      
4. 同理在点击取消的时候，我们也可以这样设置
// 取消登录
  cancel(){
    wx.switchTab({
      // url: '/pages/index/index',
      // 这里直接用的是判断之后的 goto 地址
      url:this.data.goto
    })
  },
```

```js
// pages/me/index.ts
Page({

  data: {
    phoneNumber:'',   // 手机号码
    imgUri:'../../assets/images/me-avatar.png',  // 图片地址
  },
  // 登录操作
  login(){
    wx.navigateTo({
      url: '/pages/login/index?from=me',
    })
  },
  onShow() {
    const phoneNumber = wx.getStorageSync('phoneNumber')
    this.setData({
      phoneNumber
    })
    if(phoneNumber){
      this.setData({
        imgUri:'../../assets/images/vip-pic.png'
      })
    }
  }
})
```

4. pages/login/index.js

```js
// pages/login/index.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    // 初始化登录成功后的跳转
    goto:''
  },
  login(e){
    // // 注意这里如果是个人认证是没有办法拿到手机号的
    // // console.log(e);
    // const cloudId = e.detail.CloudID
    // wx.cloud.callFunction({
    //   name:'get-phone-number',
    //   data:{
    //     weRunData: wx.clouod.CloudID(cloudId), // 这个 CloudID 值到云函数端会被替换
    //   }
    // }).then(res=>{
    //   // console.log(res);
    //   // 根据手机号码判断是否登录
    //   wx.setStorage("phoneNumber",res.result)
    //   // 跳转回来
    //   wx.switchTab({
    //     url: this.data.goto,
    //   })
    // })
    // 由于上面是个人用户，无法获取手机号，所以这里选择不去获取手机号，直接跳转页面
    wx.switchTab({
      url: this.data.goto,
    })
    wx.showToast({
      title: '登录成功',
      icon:"success",
      mask:true
    })
    wx.setStorageSync('phoneNumber', 132981691233)
  },
  // 取消登录
  cancel(){
    wx.switchTab({
      // url: '/pages/index/index',
      // 这里直接用的是判断之后的 goto 地址
      url:this.data.goto
    })
  },
  onLoad(options) {
// 从这个可以接收到调用login页面时候传入的参数，这样就可以精准控制要返回的页面，比如首页和我的页面都有登录操作，如果不能获取手机号的情况下，我们可以传入参数进行判断，是从哪里来的，比如这里就是传入了 from:me 进行得知
    console.log('login.js',options); 
       
    if(options.from == 'me'){
    // 如果是从我的页面来的
      const goto = '/pages/me/index'
      this.setData({
        goto
      })
    }else{
      // 如果是从首页登录来的
      const goto = '/pages/index/index'
      this.setData({
        goto
      })
    }
  },
})
```

5. 我们如果想要对账户信息处理，只让显示几位的话，那么我们就可以使用小程序中的 computed计算属性，来对数据进行处理，当然也可以使用 filter过滤(小程序中不推荐)，那么我们就需要先引入computed，官方文档-平台能力-扩展能力-框架扩展-computed- https://github.com/wechat-miniprogram/computed ，在使用之前，需要先把 package.json和package-lock.json 删除，然后就需要在miniprogram文件夹下使用 npm install --save miniprogram-computed，然后工具-构建npm，出来的 miniprogram_npm 就是我们需要的东西

```js
1. 在pages/me/index.js中引入 const computedBehavior = require('miniprogram-computed').behavior
2. 在Page({})里面引入
Page({
  //2. 引入
  behaviors: [computedBehavior],
    ...
 )}
3. 然后引入computed，与 data 同级别
computed: {
    sum(data) {
      // 注意： computed 函数中不能访问 this ，只有 data 对象可供访问
      // 这个函数的返回值会被设置到 this.data.sum 字段中
      return data.a + data.b + data.c // data.c 为自定义 behavior 数据段
    },
  },
```

6. pages/me/index.js

```js
// pages/me/index.ts
// 1. 引入
const computedBehavior = require('miniprogram-computed').behavior
Page({
  //2. 引入
  behaviors: [computedBehavior],
  data: {
    phoneNumber:'',   // 手机号码
    imgUri:'../../assets/images/me-avatar.png',  // 图片地址
  },
  //3. 引入
  computed: {
    // 脱敏
    desensitiveMobile(data) {
      // 注意： computed 函数中不能访问 this ，只有 data 对象可供访问
      // 这个函数的返回值会被设置到 this.data.sum 字段中
      let phoneNumber = data.phoneNumber.toString()
      if(phoneNumber){
      // {\d3} 是前三位的数字 {\d2}是后两位， {\d6}对中间内容进行处理
      phoneNumber = phoneNumber.replace(/^(\d{3})\d{6}(\d{2})$/,"$1******$2");
      }
      return phoneNumber
    },
  },
  // 登录操作
  login(){
    wx.navigateTo({
      url: '/pages/login/index?from=me',
    })
  },
  onShow() {
    const phoneNumber = wx.getStorageSync('phoneNumber')
    this.setData({
      phoneNumber
    })
    if(phoneNumber){
      this.setData({
        imgUri:'../../assets/images/vip-pic.png'
      })
    }
  }
})
```

7. pages/me/index.wxml 在页面中将 phoneNumber 替换成 desensitiveMobile

```html
<!--pages/me/index.wxml-->
<view class="page">
  <!-- 用户区域 -->
  <view class="user-area">
    <view class="user-box">
      <image class="avatar" src="{{imgUri}}"></image>
        
      <!-- desensitiveMobile 是在computed中对电话脱敏后的数据 -->
      <view class="name">{{ desensitiveMobile || '登录获得更多会员权益' }}</view>
    </view>
    <view wx:if="{{ !phoneNumber }}" class="login-btn" bindtap="login">授权登录</view>
  </view>
  <!-- 卡片区域 -->
  <view  class="card-container">
    <!-- one -->
    <view class="card">
      <view class="meta">
        <view class="count">54</view>
        <view class="name">雪王币</view>
      </view>
      <image class="icon" src="../../assets/images/me-coin.png"></image>
    </view>
    <!-- second -->
    <view class="card">
      <view class="meta">
        <view class="count">54</view>
        <view class="name">优惠券</view>
      </view>
      <image class="icon" src="../../assets/images/me-coupon.png"></image>
    </view>
  </view>
  <!-- list区域 -->
  <view class="list-items">
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/qr-code.png"></image>
        <view class="label">兑换码</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- second -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/lock.png"></image>
        <view class="label">隐私政策</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- third -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/paper.png"></image>
        <view class="label">用户协议</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
    <!-- forth -->
    <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/xuke.png"></image>
        <view class="label">经营信息公示</view>
      </view>
      <image class="left-arrow" src="../../assets/images/right.png"></image>
    </view>
  </view>
  <!-- fifth -->
  <view class="list-items app-download">
      <view class="item">
      <view class="content">
        <image class="icon" src="../../assets/images/app.png"></image>
        <view class="label">蜜雪冰城APP</view>
      </view>
      <view class="tips">下载APP体验更佳</view>
    </view>
    </view>
</view>
```

#### 标签切换组件&搜索框

1. pages/store/index.wxml

```html
<view class="page">
  <view class="header">
  <!-- 可以设置数组和对象，对象有利于指定key  抽离切换栏组件-->
   <tabs tabs="{{ [{value:'nearby',label:'附近门店'},{value:'recent',label:'常去门店'}] }}"></tabs>
      <!-- 输入框 -->
      <input type="text" class="search" placeholder="搜索门店"/>
  </view>
  <!-- map 区域 -->
  <view class="map">
  </view>
  <!--  -->
  <view class="collapse-area">
  </view>
</view>
```

2. pages/store/index.scss

```scss
.header{
  display: flex;
  padding:0 30rpx;
  box-sizing: border-box;
  width: 100%;
  justify-content: space-between;
  align-items: center;
  height: 109rpx;
  .search{
    width: 174rpx;
    height: 58rpx;
    background-color: #f5f5f5;
    padding: 18rpx 26rpx;
    border-radius: 29rpx;
    box-sizing: border-box;
    padding:0 26rpx;
    font-size: 28rpx;
    color: #d1d1d1;
  }
}
```

3. pages/store/index.json  抽离组件

```json
{
  "usingComponents": {
    "tabs":"../../components/tabs"
  },
  "navigationBarTitleText": "门店列表"
}
```

4. components/tabs/index.wxml

```html
<!--components/tabs/index.wxml-->

<view class="tabs">
    <!-- 文字内容 -->
      <view class="tab {{index === current ? 'active':''}}" bindtap="onTab" data-index="{{index}}" wx:for="{{tabs}}" wx:key="index">{{item.label}}</view>
    <!-- 底部线的样式 -->
      <view class="line" style="{{ 'width: ' + linePositionWidth + 'px; left: ' + linePositionX + 'px'}}"></view>
</view>  
```

5. components/tabs/index.scss

```scss
/* components/tabs/index.wxss 
$primary-color:#E60012;
$gray-text-color:#777777
*/
@import '../../style/theme.scss';
.tabs{
  display: flex;
  position: relative;
  .tab{
    font-size: 28rpx;
    margin-right: 20rpx;
    color: #777777;
    &.active{
      color: #000000;
      font-weight: bold;
    }
  }
  .line{
    background-color:$primary-color;
    width: 70rpx;
    height: 4rpx;
    position: absolute;
    bottom: -22rpx;
    left: 0;
    transition: all .3s;
  }
}
```

6. components/tabs/index.json

```json
{
  "component": true,
  "usingComponents": {
    
  }
}
```

7. components/tabs/index.js   重点内容，借用了API-WXML-[SelectorQuery.exec](https://developers.weixin.qq.com/miniprogram/dev/api/wxml/SelectorQuery.html)

```js
// components/tabs/index.js
Component({
  properties: {
    tabs:{
      type:Array,
      value:[]
    }
  },
  data: {
    current:0,   // 控制切换门店的样式
    linePositionX:0,  // 线的定位信息
    linePositionWidth:0, // 线的长度
  },
  // 组件生命周期
  lifetimes:{
    // 在组件实例进入页面节点树时执行
    attached(){
      // 页面刚加载的时候，需要调用一次
      this.calculateLinePositionX()
    }
  },
  methods: {
    onTab(e){
      // console.log(e.currentTarget.dataset);
      const {index} = e.currentTarget.dataset
      this.setData({
        current:index
      })
    //1. 将每次切换后的index，传入进去，因为里面有两个 class=".tab" 的元素，那么我们就需要传入一个index来确定是哪一个
    this.calculateLinePositionX(index)
    },
    // 经过计算，下面的线可以设置到中间区域
    calculateLinePositionX(index = 0){
      this.createSelectorQuery().selectAll('.tab').boundingClientRect(results=>{
        // 2. 获取具体的元素的位置信息
        const rect = results[index]
        //3. 文字的中心点坐标
        const currentCenterX = rect.left +  rect.width/2
        //4. 线的长度
        const linePositionWidth = rect.width * 0.8
        //5. 线的左侧坐标 但是这样需要注意的是，我们需要拿掉第一个元素的 padding-left
        const linePositionX = currentCenterX - linePositionWidth/2 - results[0].left
        this.setData({
          linePositionWidth,
          linePositionX
        })
      }).exec() 
    }
  }
})
```

##### 地图信息

1. pages/store/index.wxml

```html
<view class="page">
    
  <view class="header">
    <!-- 可以设置数组和对象，对象有利于指定key  抽离切换栏组件-->
    <tabs tabs="{{ [{value:'nearby',label:'附近门店'},{value:'recent',label:'常去门店'}] }}"></tabs>
    <input type="text" class="search" placeholder="搜索门店" />
  </view>
    
  <!-- map 区域  从官方直接拿 longitude latitude经纬度 bindmarkertap点开时候的位置 -->
  <map id="store-map" class="store-map" latitude="{{latitude}}" longitude="{{longitude}}" show-location markers="{{markers}}">
    <image bindtap="gotoCurrentLocation" class="current-icon" src="../../assets/images/current.png"></image>
  </map>
    
  <!-- 收起地图文字信息  -->
  <view class="collapse-area">
    <view class="collapse-tip">收起地图</view>
    <image src="../../assets/images/up.png"></image>
  </view>
</view>
```

2. pages/store/index.scss

```scss
@import '../../style/theme.scss';
.header{
  display: flex;
  padding:0 30rpx;
  box-sizing: border-box;
  width: 100%;
  justify-content: space-between;
  align-items: center;
  height: 109rpx;
  .search{
    width: 174rpx;
    height: 58rpx;
    background-color: #f5f5f5;
    padding: 18rpx 26rpx;
    border-radius: 29rpx;
    box-sizing: border-box;
    padding:0 26rpx;
    font-size: 28rpx;
    color: #d1d1d1;
  }
}
.store-map{
  width: 100%;
  height: 520rpx;
  position: relative;
  .current-icon{
    width: 44rpx;
    height: 44rpx;
    position: absolute;
    right: 18rpx;
    bottom: 22rpx;
  }
}
.collapse-area{
  width: 100%;
  height: 70rpx;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 23rpx;
  color: $gray-text-color;
  image{
    width: 30rpx;
    height: 30rpx;
    margin-left: 10rpx;
  }
}
```

3. pages/store/index.js

```js
// pages/store/index.js
Page({
  data: {
    longitude:113.613347,
    latitude:34.748349,
    // 地图上的蜜雪冰城标记点，自定义 markers
    markers:[
      {id:1,title:'实际位置',latitude:34.748349,longitude:113.613347,iconPath:'../../assets/images/marker.png', 
      width:'55rpx',height:'69rpx'}
    ]
  },
  //1. 在当前页面增加了一个成员变量 mapContext
  mapContext:null,

  onLoad(options) {
    // 获取当前位置信息
    wx.getLocation({
      type: 'gcj02',
      altitude: true, //高精度定位
      success: (res)=> {
        console.log(111);
        const latitude = res.latitude
        const longitude = res.longitude
        this.setData({
          latitude,
          longitude
        })
      }
     })
    // 点击右下角小图标返回当前位置  
    wx.createSelectorQuery().select('#store-map').context(res=>{
      //2. 刚加载页面的时候我们进行一个对 mapContext 的获取
      this.mapContext = res.context;
    }).exec()
  },
  //3. 点击回到中心点位置
  gotoCurrentLocation(){
    // 4. 任何一个位置只要点击就回到当前位置
    this.mapContext.moveToLocation()
  }
})
```

4. pages/store/index.json

```json
{
  "usingComponents": {
    "tabs":"../../components/tabs"
  },
  "navigationBarTitleText": "门店列表"
}
```

##### 点餐商铺列表

1. pages/store/index.wxml

```html
<view class="page">
  <view class="header">
    <!-- 可以设置数组和对象，对象有利于指定key  抽离切换栏组件-->
    <tabs tabs="{{ [{value:'nearby',label:'附近门店'},{value:'recent',label:'常去门店'}] }}"></tabs>
    <input type="text" class="search" placeholder="搜索门店" />
  </view>
  <!-- map 区域  从官方直接拿 longitude latitude经纬度 bindmarkertap点开时候的位置 -->
  <map id="store-map" class="store-map" latitude="{{latitude}}" longitude="{{longitude}}" show-location markers="{{markers}}">
    <image bindtap="gotoCurrentLocation" class="current-icon" src="../../assets/images/current.png"></image>
  </map>
  <!-- 收起地图文字信息  -->
  <view class="collapse-area">
    <view class="collapse-tip">收起地图</view>
    <image src="../../assets/images/up.png"></image>
  </view>
  <!-- 店铺信息 -->
  <scroll-view class="store-list" scroll-y>
    <view class="store-box" wx:for="2" wx:key="*this">
      <view class="info-area">
        <view class="name">蜜雪冰城（潘水店）</view>
        <view class="info">郑州市191号</view>
        <view class="info">营业时间: 09:00 ~ 22:00 </view>
        <view class="tag">营业中</view>
      </view>
      <view class="location-area">
        <view class="distance">距离1.3km</view>
        <view class="action-area">
          <view class="location">
        <image class="location" src="../../assets/images/location.jpg"></image>
            <image class="phone" src="../../assets/images/phone.jpg"></image>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view>
```

2. pages/store/index.scss

```scss
@import '../../style/theme.scss';
.header{
  display: flex;
  padding:0 30rpx;
  box-sizing: border-box;
  width: 100%;
  justify-content: space-between;
  align-items: center;
  height: 109rpx;
  .search{
    width: 174rpx;
    height: 58rpx;
    background-color: #f5f5f5;
    padding: 18rpx 26rpx;
    border-radius: 29rpx;
    box-sizing: border-box;
    padding:0 26rpx;
    font-size: 28rpx;
    color: #d1d1d1;
  }
}
.store-map{
  width: 100%;
  height: 520rpx;
  position: relative;
  .current-icon{
    width: 44rpx;
    height: 44rpx;
    position: absolute;
    right: 18rpx;
    bottom: 22rpx;
  }
}
.collapse-area{
  width: 100%;
  height: 70rpx;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 23rpx;
  color: $gray-text-color;
  image{
    width: 30rpx;
    height: 30rpx;
    margin-left: 10rpx;
  }
}
.store-list{
  width: 100%;
  height: calc(100vh - 700rpx);
  background-color: #f8f8f8;
  // 小程序一般都是怪异盒子模型，所以一般都是需要设置 box-sizing 的
  box-sizing: border-box;
  .store-box{
    background-color: #ffffff;
    padding:25rpx;
    margin: 14rpx 25rpx;
    display: flex;
    align-items: center;
    .info-area{
      border-right: 1px solid #eeeeee;
      // 这样弹性盒子的效果就出来了，占满后面的空间
      flex: 1;
      .name{
        font-size: 28rpx;
        font-weight: bold;
        margin-bottom:12rpx;
      }
      .info{
        font-size: 18rpx;
        color: $gray-text-color;
        margin-bottom: 12rpx;
      }
      .tag{
        // 这样不是一个block，是一个inline的话就可以做 padding 了
        display: inline-block;
        background-color: $primary-color;
        color: #fff;
        font-size: 18rpx;
        padding: 6rpx;
      }
    }
    .location-area{
      height: 112rpx;
      margin-left: 25rpx;
      display: flex;
      flex-direction: column;
      align-items: center;
      .distance{
        font-size: 20rpx;
        color: $gray-text-color;
        margin-bottom: 35rpx;
      }
      .action-area{
        display: flex;
        width: 112rpx;
        justify-content: space-around;
        image{
          width: 40rpx;
          height: 40rpx;
        }
      }
    }
  }
}
```

3. pages/store/index.js  2022-11-06

```js

```

